# Workflow H√≠brido - Limpieza Referencias MUVA Chat

**Proyecto:** Eliminar referencias legacy "MUVA Chat" del codebase
**Fecha:** 2025-10-10
**Estrategia:** Opci√≥n C (Single Session con TodoList + Safety Protocol)
**Tiempo Estimado:** 1.5-2h

---

## üéØ OBJETIVO

Eliminar TODAS las referencias "MUVA Chat" del proyecto, dejando solo "MUVA Chat".

**Problema Actual:**
- Codebase tiene 200+ menciones "innpilot" (archivos, paths, c√≥digo TypeScript)
- GitHub Actions deployment FALLA porque usa paths `/var/www/muva-chat` (incorrectos)
- C√≥digo TypeScript soporta `muva.chat` (dominio legacy que queremos descontinuar)
- Documentaci√≥n inconsistente (mezcla MUVA Chat/MUVA)

**Estado Deseado:**
- ‚úÖ GitHub Actions funciona con paths `/var/www/muva-chat`
- ‚úÖ C√≥digo solo soporta `muva.chat` (eliminar muva.chat)
- ‚úÖ Nginx redirige `*.muva.chat` ‚Üí `*.muva.chat` (sin romper subdominios existentes)
- ‚úÖ Documentaci√≥n consistente (solo MUVA Chat)

---

## üìä ESTRATEGIA (Opci√≥n C)

**Hybrid Approach:**
- ‚úÖ Single session (r√°pido, menos overhead)
- ‚úÖ TodoList tracking (visibilidad de progreso)
- ‚úÖ Testing incremental (seguridad)
- ‚úÖ Commits por categor√≠a (rollback f√°cil)
- ‚ö†Ô∏è Escalate a Plan Formal si se complica

**Por qu√© no Plan Formal:**
- An√°lisis exhaustivo YA est√° hecho
- Cambios son mayormente buscar-reemplazar
- Context usage (78%) es alto pero manejable

**Por qu√© no Single Session "YOLO":**
- Necesitamos testing entre cambios
- Hay producci√≥n activa (no podemos romperla)
- Context podr√≠a llegar a l√≠mite

---

## üöÄ PROMPT EJECUTABLE (COPY-PASTE)

**Instrucciones:**
1. Haz `/clear` en nueva conversaci√≥n
2. Copy-paste el siguiente prompt COMPLETO
3. Sigue las instrucciones del asistente

---

### PROMPT COMIENZA AQU√ç ‚¨áÔ∏è

```
PROYECTO: Limpieza Referencias MUVA Chat ‚Üí MUVA Chat

OBJETIVO:
Eliminar TODAS las referencias "MUVA Chat" del codebase MUVA Chat de manera segura, con testing incremental y commits por categor√≠a.

CONTEXTO:
- Repo: /Users/oneill/Sites/apps/muva-chat
- Producci√≥n ACTIVA en VPS (195.200.6.216)
- GitHub Actions deployment FALLA (usa paths incorrectos)
- Necesitamos: Testing + Commits incrementales
- NO romper producci√≥n

AN√ÅLISIS PREVIO COMPLETO:
Ver archivo: docs/projects/innpilot-cleanup/workflow-hibrido-migracion.md

---

TASKS (Ejecutar en orden, con testing entre cada una):

## TASK 1: CR√çTICO - GitHub Actions (30min) üî¥

**Archivos (3):**
1. docs/deployment/ecosystem.config.cjs:6
   - `cwd: '/var/www/muva-chat'` ‚Üí `cwd: '/var/www/muva-chat'`

2. docs/deployment/GITHUB_SECRETS.md
   - L√≠nea 7: URL repo ‚Üí `https://github.com/toneill57/muva-chat`
   - L√≠nea 61: `VPS_APP_PATH` ‚Üí `/var/www/muva-chat`

3. **Usuario manual:** GitHub Secret
   - Settings ‚Üí Secrets ‚Üí Actions ‚Üí `VPS_APP_PATH`
   - Cambiar: `/var/www/muva-chat` ‚Üí `/var/www/muva-chat`

**TEST:**
- Leer ecosystem.config.cjs l√≠nea 6 (verificar path correcto)
- Leer GITHUB_SECRETS.md l√≠neas 7 y 61 (verificar docs actualizados)
- Usuario verifica GitHub Secret (manual)

**COMMIT:** "fix(deploy): update paths from innpilot to muva-chat"

---

## TASK 2: C√ìDIGO - TypeScript Files (30min) üü°

**Archivos (5):**

1. **next.config.ts (l√≠neas 58, 69)**
   - Regex: `innpilot\\.io` ‚Üí ELIMINAR
   - ANTES: `(localhost|innpilot\\.io|muva\\.chat)`
   - DESPU√âS: `(localhost|muva\\.chat)`

2. **src/lib/tenant-utils.ts**
   - L√≠nea 44-60: Eliminar bloque `if (host.endsWith('.muva.chat'))`
   - L√≠nea 14-17: Actualizar comentarios (quitar ejemplos muva.chat)
   - L√≠nea 24-27: Actualizar JSDoc examples (quitar muva.chat)
   - L√≠nea 63: Actualizar comentario final

3. **src/lib/claude.ts (l√≠neas 54, 76)**
   - System prompts: "MUVA Chat" ‚Üí "MUVA Chat"

4. **src/hooks/useChatState.tsx (l√≠nea 23)**
   - `STORAGE_KEY = 'innpilot_chat_state'` ‚Üí `'muva_chat_state'`
   - ‚ö†Ô∏è NOTA: Esto borrar√° localStorage existente

5. **package-lock.json (l√≠neas 2, 8)**
   - `"name": "innpilot"` ‚Üí `"name": "muva-chat"`

**TEST:**
- Leer cada archivo modificado (verificar cambios)
- Ejecutar: `npm run build` (verificar que compila sin errores)
- Verificar en browser: localStorage usa nueva key

**COMMIT:** "refactor: remove muva.chat support, use muva.chat only"

---

## TASK 3: NGINX - Redirect Config (15min) üü¢

**Archivo (1):**
- docs/deployment/nginx-subdomain.conf

**Cambios:**
- L√≠nea 2: "MUVA Chat + MUVA.chat" ‚Üí "MUVA Chat (with muva.chat redirect)"
- L√≠neas 5-67: MODIFICAR bloque muva.chat (NO eliminar)
  - Agregar redirect 301 en location /
  - Redirigir `*.muva.chat` ‚Üí `*.muva.chat`

**C√≥digo sugerido:**
```nginx
# HTTPS server block - Redirect muva.chat to muva.chat
server {
    listen 443 ssl http2;
    server_name *.muva.chat muva.chat;

    # SSL Configuration (mantener certificado existente)
    ssl_certificate /etc/letsencrypt/live/muva.chat-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/muva.chat-0001/privkey.pem;

    # Extract subdomain
    set $subdomain "";
    if ($host ~* ^([^.]+)\.innpilot\.io$) {
        set $subdomain $1;
    }

    # Redirect to muva.chat preserving subdomain
    location / {
        if ($subdomain != "") {
            return 301 https://$subdomain.muva.chat$request_uri;
        }
        return 301 https://muva.chat$request_uri;
    }
}
```

**TEST:**
- Leer nginx-subdomain.conf (verificar redirect est√° correcto)
- Syntax check: `sudo nginx -t` (en VPS, post-deploy)

**COMMIT:** "feat(nginx): redirect muva.chat to muva.chat"

---

## TASK 4: SCRIPTS - Deployment Scripts (15min) üü¢

**Archivos (7):**
1. scripts/verify-deployment.sh
   - L√≠nea 16: `DOMAIN="muva.chat"` ‚Üí `DOMAIN="muva.chat"`
   - L√≠nea 159: `pm2 status muva-chat` ‚Üí `pm2 status muva-chat`

2. docs/deployment/nginx-innpilot.conf
   - Agregar nota al inicio: "‚ö†Ô∏è DEPRECATED - Use nginx-subdomain.conf"
   - O ELIMINAR archivo (m√°s limpio)

3. Otros scripts con refs `/var/www/muva-chat`:
   - Buscar con: `grep -r "/var/www/muva-chat" scripts/`
   - Reemplazar: `/var/www/muva-chat` ‚Üí `/var/www/muva-chat`

**TEST:**
- Ejecutar: `bash scripts/verify-deployment.sh --dry-run` (si existe flag)
- Leer cada script modificado (verificar cambios)

**COMMIT:** "chore: update deployment scripts for muva-chat"

---

## TASK 5: DOCS - Documentation Cleanup (45min) üìö

**Archivos (50+):**

**Estrategia:** Buscar-reemplazar batch en categor√≠as

**Categor√≠as:**
1. **Deployment docs** (15 archivos en `docs/deployment/`)
   - Buscar: `/var/www/muva-chat` ‚Üí `/var/www/muva-chat`
   - Buscar: `pm2.*innpilot` ‚Üí `pm2 ... muva-chat`

2. **Feature docs** (30 archivos en `docs/tenant-subdomain-chat/`, etc.)
   - Buscar: `simmerdown.muva.chat` ‚Üí `simmerdown.muva.chat`
   - Buscar: "MUVA Chat" ‚Üí "MUVA Chat" (texto descriptivo)

3. **Snapshots** (10 archivos en `snapshots/`)
   - Buscar: "MUVA Chat" ‚Üí "MUVA Chat"
   - Buscar: `muva.chat` ‚Üí `muva.chat`

4. **Root docs** (README.md, SNAPSHOT.md, VPS_MIGRATION_INSTRUCTIONS.md)
   - Manual review (cambios m√°s cr√≠ticos)

**ELIMINACIONES:**
- `docs/projects/innpilot-to-muva-rebrand/` ‚Üí Proyecto completado, puede eliminar carpeta

**TEST:**
- Verificar: `grep -ri "innpilot" docs/ | wc -l` (deber√≠a ser ~0 o muy bajo)
- Verificar: `grep -ri "/var/www/muva-chat" . | wc -l` (deber√≠a ser ~0)

**COMMIT:** "docs: complete innpilot to muva-chat migration"

---

INSTRUCCIONES PARA CLAUDE:

1. **TodoWrite**: Crear todo list con estas 5 tasks
2. **Ejecutar en orden**: Task 1 ‚Üí Test ‚Üí Commit ‚Üí Task 2 ‚Üí ...
3. **NO avanzar** a siguiente task sin testing
4. **Mostrar evidencia** de cada test al usuario
5. **Commits incrementales**: Uno por task completado
6. **Safety check**: Si context usage >90% ‚Üí avisar al usuario
7. **Escalate**: Si encuentras problemas inesperados ‚Üí sugerir Plan Formal

**VERIFICACI√ìN FINAL:**
Despu√©s de TASK 5, ejecutar:
```bash
# Verificar refs innpilot eliminadas
grep -ri "innpilot" . --exclude-dir=node_modules --exclude-dir=.next | wc -l

# Verificar path viejo eliminado
grep -r "/var/www/muva-chat" . --exclude-dir=node_modules | wc -l

# Build exitoso
npm run build
```

¬øListo para empezar con TASK 1?
```

### PROMPT TERMINA AQU√ç ‚¨ÜÔ∏è

---

## ‚úÖ TODO LIST (Para tracking durante ejecuci√≥n)

```markdown
# TODO - Limpieza MUVA Chat

- [ ] TASK 1: CR√çTICO - GitHub Actions (30min)
  - [ ] ecosystem.config.cjs
  - [ ] GITHUB_SECRETS.md
  - [ ] GitHub Secret (usuario manual)
  - [ ] TEST: Verificar archivos + secret
  - [ ] COMMIT: fix(deploy)

- [ ] TASK 2: C√ìDIGO - TypeScript (30min)
  - [ ] next.config.ts
  - [ ] src/lib/tenant-utils.ts
  - [ ] src/lib/claude.ts
  - [ ] src/hooks/useChatState.tsx
  - [ ] package-lock.json
  - [ ] TEST: npm run build
  - [ ] COMMIT: refactor

- [ ] TASK 3: NGINX - Redirect (15min)
  - [ ] nginx-subdomain.conf (modificar, no eliminar)
  - [ ] TEST: Verificar syntax
  - [ ] COMMIT: feat(nginx)

- [ ] TASK 4: SCRIPTS - Deployment (15min)
  - [ ] verify-deployment.sh
  - [ ] nginx-innpilot.conf (deprecate o eliminar)
  - [ ] Otros scripts batch
  - [ ] TEST: Dry-run scripts
  - [ ] COMMIT: chore

- [ ] TASK 5: DOCS - Cleanup (45min)
  - [ ] docs/deployment/ (15 files)
  - [ ] docs/tenant-subdomain-chat/ (30 files)
  - [ ] snapshots/ (10 files)
  - [ ] Root docs (README, SNAPSHOT, etc.)
  - [ ] TEST: grep counts
  - [ ] COMMIT: docs

**Total:** 5 tasks, ~2h, 5 commits
```

---

## üõ°Ô∏è SAFETY PROTOCOL

### Testing Obligatorio

**Despu√©s de cada TASK:**
```bash
# TASK 1-2: Build check
npm run build

# TASK 3: Nginx syntax (en VPS)
sudo nginx -t

# TASK 4: Script validation
bash scripts/verify-deployment.sh --help

# TASK 5: Grep verification
grep -ri "innpilot" docs/ | wc -l
```

### Commits Incrementales

**Mensaje format:**
```
{type}({scope}): {description}

TASK {N}: {Task name}
Files changed: {count}
```

**Beneficio:** Si algo falla, rollback es f√°cil (`git reset HEAD~1`)

### Context Monitoring

**Current:** 78% (156k/200k)

**Thresholds:**
- 85% ‚Üí Warning (considerar compactar)
- 90% ‚Üí STOP, hacer `/clear` + resumen
- 95% ‚Üí Force stop

---

## üîÑ PLAN B (Escalation)

**Triggers para cambiar a Plan Formal:**

1. **Problemas T√©cnicos:**
   - Test falla en TASK 1-2 (cr√≠ticos)
   - Nginx syntax error (TASK 3)
   - npm build error (TASK 2)

2. **Context Issues:**
   - Usage llega a 90%
   - Necesitas `/clear` antes de TASK 5

3. **Time Issues:**
   - Necesitas pausar >24h entre tasks
   - Session interrumpida por otro proyecto

**Acci√≥n:**
1. Crear `docs/projects/innpilot-cleanup/plan.md`
2. Crear `docs/projects/innpilot-cleanup/TODO.md`
3. Crear `docs/projects/innpilot-cleanup/workflow.md`
4. Documentar progreso actual en `docs/projects/innpilot-cleanup/fase-1/PROGRESS.md`

---

## üß™ VERIFICACI√ìN POST-CAMBIOS

### Quick Checks

```bash
# 1. Referencias innpilot (debe ser ~0)
grep -ri "innpilot" . --exclude-dir=node_modules --exclude-dir=.next | wc -l

# 2. Path viejo (debe ser 0)
grep -r "/var/www/muva-chat" . --exclude-dir=node_modules | wc -l

# 3. Build exitoso
npm run build

# 4. Package.json correcto
cat package.json | grep '"name"'
```

### Production Validation

**En VPS (post-deploy):**
```bash
# 1. PM2 status
pm2 status muva-chat

# 2. Nginx config
sudo nginx -t

# 3. Health check
curl https://muva.chat/api/health

# 4. Subdomain test
curl https://simmerdown.muva.chat/chat
```

---

## üìä M√âTRICAS DE √âXITO

**Funcionalidad:**
- [ ] GitHub Actions deployment funciona
- [ ] C√≥digo compila sin errores
- [ ] Nginx redirige muva.chat ‚Üí muva.chat
- [ ] Subdominios existentes funcionan
- [ ] Health checks pasan

**Limpieza:**
- [ ] Refs "innpilot" < 5 (solo en docs hist√≥ricos archivados)
- [ ] Refs "/var/www/muva-chat" = 0
- [ ] Package.json name = "muva-chat"
- [ ] localStorage usa nueva key

**Performance:**
- [ ] Build time sin cambios significativos
- [ ] Context usage < 85% al finalizar
- [ ] 5 commits limpios en git history

---

## üìù NOTAS

### Qu√© NO cambiar

- `src/lib/integrations/motopress/client.ts:66` - User-Agent puede quedar
- `src/lib/staff-auth.ts:41` - JWT secret default (no afecta)
- `docs/archive/*` - Preservar historia (no modificar)

### Rollback Emergency

**Si algo cr√≠tico falla:**
```bash
# Rollback √∫ltimo commit
git reset --hard HEAD~1

# O rollback a commit espec√≠fico
git log --oneline | head -5
git reset --hard {commit-hash}

# Force push si ya subiste
git push origin dev --force
```

---

**√öltima actualizaci√≥n:** 2025-10-10
**Pr√≥ximo paso:** Ejecutar PROMPT en nueva conversaci√≥n con `/clear`
