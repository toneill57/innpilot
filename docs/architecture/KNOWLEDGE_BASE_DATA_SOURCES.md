# Knowledge Base Data Sources

**Purpose:** Explains which database tables feed the Knowledge Base UI and how to delete tenant data correctly.

**Problem Solved:** When user requests "delete accommodation documents" or "clear knowledge base", this document provides exact table locations and SQL commands to avoid confusion.

---

## üóÇÔ∏è Three Data Sources

The Knowledge Base UI (`[tenant].muva.chat/admin/knowledge-base`) displays data from **3 different tables**:

### 1. **General Knowledge Documents**
**Table:** `tenant_knowledge_embeddings` (public schema)

**Content:**
- Manual uploads (PDFs, markdown files)
- General hotel documentation
- Grouped by `file_path`

**Example:**
```sql
SELECT file_path, COUNT(*) as chunks, MAX(created_at) as uploaded
FROM tenant_knowledge_embeddings
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf'  -- Simmerdown
GROUP BY file_path;
```

---

### 2. **Accommodation Semantic Chunks** ‚≠ê CRITICAL
**Table:** `accommodation_units_public` (public schema)

**Content:**
- Semantic chunks from markdown v3.0 files
- Generated by `scripts/sync-accommodations-to-public.ts`
- Each chunk = 1 row (7-8 chunks per accommodation)
- Displayed as individual "files" in Knowledge Base UI

**Structure:**
- `name`: "Apartamento Summertime - Overview" (chunk title)
- `description`: Full chunk content (~1,000-2,000 chars)
- `metadata`: Contains section_type, section_title, original_accommodation
- `embedding_fast`: 1024d vector for similarity search

**Example:**
```sql
SELECT
  name,
  LENGTH(description) as chunk_size,
  metadata->>'section_type' as section_type,
  created_at
FROM accommodation_units_public
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf'  -- Simmerdown
ORDER BY created_at DESC;
```

**Current counts:**
- Simmerdown: 65 chunks (9 accommodations)
- Tu Casa Mar: 42 chunks (6 accommodations)

---

### 3. **Hotel Policies**
**Table:** `policies` (hotels schema, NOT public)

**Content:**
- Hotel operational policies
- Check-in/out rules
- Cancellation policies
- Each policy = 1 row

**Example:**
```sql
SELECT policy_id, title, source_file, created_at
FROM policies
WHERE tenant_id = '2263efba-b62b-417b-a422-a84638bc632f'  -- Tu Casa Mar
ORDER BY created_at DESC;
```

---

## üóëÔ∏è How to Delete Tenant Data

### ‚ö†Ô∏è Current UI DELETE Bug

**Problem:** The DELETE button in Knowledge Base UI only deletes from `tenant_knowledge_embeddings`.

**Code location:** `src/app/api/admin/knowledge-base/route.ts` (lines 191-195)

```typescript
// Current implementation (INCOMPLETE)
const { error, count } = await supabase
  .from('tenant_knowledge_embeddings')  // ‚Üê Only deletes from this table
  .delete({ count: 'exact' })
  .eq('tenant_id', tenant_id)
  .eq('file_path', file_path)
```

**Impact:** If you click DELETE on "accommodations/Summertime" in UI, nothing happens because:
- UI displays data from `accommodation_units_public`
- DELETE executes on `tenant_knowledge_embeddings`
- Result: UI still shows 65 chunks after "delete"

---

### ‚úÖ Correct DELETE Commands

When user says **"delete all accommodation documents"** or **"clear Simmerdown knowledge base"**:

#### Option A: Delete ONLY Accommodations

```sql
-- Simmerdown accommodations
DELETE FROM accommodation_units_public
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';

-- Tu Casa Mar accommodations
DELETE FROM accommodation_units_public
WHERE tenant_id = '2263efba-b62b-417b-a422-a84638bc632f';
```

**Using MCP Supabase:**
```typescript
mcp__supabase__execute_sql({
  project_id: "ooaumjzaztmutltifhoq",
  query: `DELETE FROM accommodation_units_public
          WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf'`
})
```

---

#### Option B: Delete EVERYTHING (Complete Cleanup)

```sql
-- Delete ALL knowledge base data for Simmerdown
BEGIN;

-- 1. Accommodation chunks (semantic)
DELETE FROM accommodation_units_public
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';

-- 2. General knowledge documents
DELETE FROM tenant_knowledge_embeddings
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';

-- 3. Policies
DELETE FROM policies
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';

COMMIT;
```

---

#### Option C: Delete Specific Accommodation

```sql
-- Delete all chunks for "Apartamento Summertime"
DELETE FROM accommodation_units_public
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf'
AND name LIKE 'Apartamento Summertime%';
-- Matches: "Apartamento Summertime - Overview", "Apartamento Summertime - Amenities", etc.
```

---

## üìä Verify Deletion

After deleting, verify with:

```sql
-- Check accommodation counts
SELECT
  COUNT(*) as total_chunks,
  COUNT(DISTINCT unit_number) as unique_accommodations
FROM accommodation_units_public
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';

-- Check general knowledge counts
SELECT COUNT(*) as chunks
FROM tenant_knowledge_embeddings
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';

-- Check policies counts
SELECT COUNT(*) as policies
FROM policies
WHERE tenant_id = 'b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf';
```

---

## üîó Related Tables (NOT shown in Knowledge Base UI)

These tables exist but are **NOT displayed** in Knowledge Base UI:

- `hotels.accommodation_units` - Legacy MotoPress integration (6 Tu Casa Mar units)
- `accommodation_units` (public schema) - Different purpose
- `accommodation_units_manual` - Old manual entries
- `accommodation_units_manual_chunks` - Deprecated
- `code_embeddings` - For code documentation

**DO NOT delete from these unless specifically requested.**

---

## üéØ Quick Reference

| User Request | Table to DELETE from | Match Column |
|--------------|---------------------|--------------|
| "Delete Simmerdown accommodations" | `accommodation_units_public` | `tenant_id` |
| "Delete Tu Casa Mar knowledge base" | `tenant_knowledge_embeddings` + `accommodation_units_public` + `policies` | `tenant_id` |
| "Delete Apartamento Summertime" | `accommodation_units_public` | `tenant_id` + `name LIKE '%'` |
| "Clear all Simmerdown docs" | All 3 tables | `tenant_id` |

---

## üìå Tenant IDs Reference

- **Simmerdown:** `b5c45f51-a333-4cdf-ba9d-ad0a17bf79bf`
- **Tu Casa Mar:** `2263efba-b62b-417b-a422-a84638bc632f`

---

**Last Updated:** October 2025
**Related Workflows:** `docs/workflows/ACCOMMODATION_SYNC_UNIVERSAL.md`
